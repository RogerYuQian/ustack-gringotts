# -*- coding: utf-8 -*-
import json
import requests
import datetime

CLOUDS = {"uos": {"os_auth_url": "http://i.l7.0.uc.ustack.in:35357/v3",
                  "regions": ["RegionOne", "zhsh"],
                  "admin_user": "admin",
                  "admin_password": "password",
                  "admin_tenant_name": "admin"},
          "mm": {"os_auth_url": "http://l7.0.mm.ustack.in:35357/v3",
                 "regions": ["RegionOne"],
                 "admin_user": "admin",
                 "admin_password": "password",
                 "admin_tenant_name": "admin"},
          "zhj": {"os_auth_url": "http://l7.0.zhj.ustack.in:35357/v3",
                 "regions": ["RegionOne"],
                 "admin_user": "admin",
                 "admin_password": "password",
                 "admin_tenant_name": "admin"},
          "sh": {"os_auth_url": "http://l7.0.sh.ustack.in:35357/v3",
                 "regions": ["RegionOne"],
                 "admin_user": "admin",
                 "admin_password": "password",
                 "admin_tenant_name": "admin"},
}


def force_v3_api(url):
    if url is none:
        return url
    if url.endswith('/v2.0'):
        return url.replace('/v2.0', '/v3')
    return url


def get_ks_client(cloud):
    ks_client = client.Client(user_domain_name="Default"
                              username=cloud['admin_user'],
                              password=cloud['admin_password'],
                              project_domain_name="Default",
                              project_name=cloud['admin_tenant_name'],
                              auth_url=cloud['os_auth_url'])
    ks_client.management_url = force_v3_api(ks_client.management_url)
    return ks_client


def get_token():
    return get_ks_client().auth_token


def get_admin_tenant_id():
    return get_ks_client().project_id


def _get_catalog(cloud):
    try:
        endpoints = get_ks_client(cloud).endpoints.list()
        services = get_ks_client(cloud).services.list()
    except Exception as e:
        LOG.exception('failed to load endpoints from kesytone:%s' % e)
        return []

    catalog = []

    for service in services:
        _endpoints = []
        for endpoint in endpoints:
            if endpoint.service_id == service.id:
                url=force_v3_api(endpoint.url) if service.type=='identity' else endpoint.url
                _endpoints.append(dict(id=endpoint.id,
                                       interface=endpoint.interface,
                                       url=url,
                                       region=endpoint.region))
        _service = dict(id=service.id,
                        type=service.type,
                        endpoints=_endpoints)

        catalog.append(_service)

    return catalog


def get_endpoint(cloud, region_name, service_type):
    catalog = _get_catalog(cloud)

    endpoint_type = 'admin'
    project_id = get_admin_tenant_id()

    for service in catalog:
        if service['type'] != service_type:
            continue

        endpoints = service['endpoints']
        for endpoint in endpoints:
            if endpoint.get('interface') != endpoint_type:
                continue
            if region_name and endpoint.get('region') != region_name:
                continue
            return (endpoint['url'].replace('$', '%') %
                    {'tenant_id': project_id, 'project_id': project_id})


def get_novaclient(cloud, region_name=None):
    endpoint = get_endpoint(cloud, region_name, 'compute')
    auth_token = get_token()

    c = nova_client.Client(cloud['admin_user'],
                           cloud['admin_password'],
                           None, # project_id is not required
                           auth_url=cloud['os_auth_url'])

    # Give auth_token and management_url directly to avoid authenticate again.
    c.client.auth_token = auth_token
    c.client.management_url = endpoint
    return c


def server_list(cloud, project_id=None, region_name=None):
    search_opts = {'all_tenants': 1}

    if project_id:
        search_opts.update(project_id=project_id)

    return get_novaclient(cloud, region_name).servers.list(detailed=False,
                                                           search_opts=search_opts)
 

def get_cinderclient(cloud, region_name=None):
    endpoint = get_endpoint(cloud, region_name, 'volume')
    auth_token = get_token()
    c = cinder_client.Client(cloud['admin_user'],
                             cloud['admin_password'],
                             None,
                             auth_url=cloud['os_auth_url'])
    c.client.auth_token = auth_token
    c.client.management_url = endpoint
    return c


def volume_list(cloud, project_id=None, region_name=None):
    """To see all volumes in the cloud as admin.
    """
    c_client = get_cinderclient(cloud, region_name)
    search_opts = {'all_tenants': 1}
    if project_id:
       search_opts.update(project_id=project_id)
    if c_client is None:
        return []
    return c_client.volumes.list(detailed=False, search_opts=search_opts)
 

def get_neutronclient(cloud, region_name=None):
    endpoint = get_endpoint(cloud, region_name, 'network')
    auth_token = get_token()
    c = neutron_client.Client(token=auth_token,
                              endpoint_url=endpoint)
    return c


def floatingip_list(cloud, project_id=None, region_name=None):
    client = get_neutronclient(cloud, region_name)
    if project_id:
        fips = client.list_floatingips(tenant_id=project_id).get('floatingips')
    else:
        fips = client.list_floatingips().get('floatingips')

    return fips


resource_count = []
for region in REGIONS:
    line = (region,)
    line = line + tuple((get_resource_count(region, type) for type in RESOURCE_TYPE))
    resource_count.append(line)

yesterday = datetime.date.today() - datetime.timedelta(days=1)

# send email
content = u"<p>[%s]资源报表:</p>" % yesterday
content += u"<table border=\"1\" style=\"border-collapse:collapse;\"><thead><tr><th>区域</th><th>主机</th><th>云硬盘</th><th>公网IP</th></tr></thead>"
for line in resource_count:
    content += u"<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>" % (line[0], line[1], line[2], line[3])
content += u"</table><br/>"

url="https://sendcloud.sohu.com/webapi/mail.send.xml"

params = {"api_user": "postmaster@unitedstack-trigger.sendcloud.org",
          "api_key": "7CVvlTcXvVDgMo8U",
          "from": "notice@mail.unitedstack.com",
          "fromname": "UnitedStack",
          #"to": "support@unitedstack.com",
          "to": "guangyu@unitedstack.com",
          "subject": '[UnitedStack][%s]资源报表' % yesterday,
          "template_invoke_name": "register",
          "html": content.encode('utf-8')}

r = requests.post(url, data=params)
